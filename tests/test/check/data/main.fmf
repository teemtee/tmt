/dmesg:
    test: /bin/true
    check: dmesg

    /harmless:

    /segfault:
        test: echo Some segfault happened > /dev/kmsg

    /custom-patterns:
        check:
          - how: dmesg
            failure-pattern:
              - 'Hypervisor detected'

/avc:
  check:
    - how: avc

  /harmless:
    test: /bin/true
    order: 100

  /nasty:
    test: |
      set -x
      systemctl status auditd || /bin/true
      systemctl start auditd
      sudo bash -c "passwd --help &> /root/passwd.log; \
                    ls -alZ /root/passwd.log; \
                    rm -f /root/passwd.log" || /bin/true

/watchdog/ping:
  require:
    - /usr/bin/uptime

  test: |
    set -x

    export
    uptime

    if [ "$TMT_REBOOT_COUNT" = "1" ]; then exit 0; fi

    # Collect a couple of successful responses
    sysctl net.ipv4.icmp_echo_ignore_all
    sysctl net.ipv6.icmp.echo_ignore_all

    echo "test starts, will sleep for a while"
    sleep 120
    uptime

    # Trigger kernel panic. There should be no development after this line,
    # but to be sure, sleep more.
    echo c > /proc/sysrq-trigger

    # Now wait to be noticed by the watchdog
    sleep 300

  duration: 30m

  check:
    - how: watchdog

      interval: 5
      reboot: true

      # The only viable way to test this with easy-to-setup guests is `virtual` + SSH.
      # Cannot use ping, we'd be pinging our own localhost, and Beaker requires nontrivial
      # setup. The watchdog should detect this & disable the ping probe.
      ping: true

      ssh-ping: true
      ssh-ping-threshold: 3
