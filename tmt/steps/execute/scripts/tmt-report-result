#!/bin/bash
set -o errexit -o pipefail -o noclobber -o nounset
REPORT_RESULT_OUTPUTFILE="$TMT_TEST_DATA/results.yaml"
server=
outputFile=
disablePlugin=
port=
message=
help=False

die() { echo "$*" >&2; exit 2; }  # complain to STDERR and exit with error
needs_arg() { if [ -z "$OPTARG" ]; then die "No arg for --$OPT option"; fi; }

write_report_file () {
    if [ -n "$server" ]; then message="$message server=$server"; fi
    if [ -n "$port" ]; then message="$message port=$port"; fi
    if [ -n "$METRIC" ]; then message="$message metric=$METRIC"; fi
    if [ -n "$disablePlugin" ]; then message="$message disablePlugin=$disablePlugin"; fi
    echo "  - name: ${TESTNAME}" >> "$REPORT_RESULT_OUTPUTFILE"
    echo "    fmf_id:" >> "$REPORT_RESULT_OUTPUTFILE"
    echo "        name: ${TESTNAME}" >> "$REPORT_RESULT_OUTPUTFILE"
    echo "    result: ${TESTRESULT}" >> "$REPORT_RESULT_OUTPUTFILE"
    echo "    note: ${message}" >> "$REPORT_RESULT_OUTPUTFILE"
    if [ -n "${outputFile}" ]; then
        echo "    log:" >> "$REPORT_RESULT_OUTPUTFILE"
        echo "      - ${outputFile}" >> "$REPORT_RESULT_OUTPUTFILE"
    fi
    echo "    data-path: $TMT_TEST_DATA" >> "$REPORT_RESULT_OUTPUTFILE"
    echo "">> "$REPORT_RESULT_OUTPUTFILE"
}

copy_outputfile_to_data_dir () {
    filename=$(echo "$outputFile" | awk -F/ '{print $NF}')
    # Replace slashes in test name with underscores.
    fileprefix=$(echo "$TESTNAME" | tr / _ | tr ' ' _)
    # Cut first char if underscore.
    if [[ ${fileprefix:0:1} == '_' ]]; then fileprefix=$(echo "$fileprefix" | cut -c 2-); fi
    # Copy outputfile to data dir. Prefix with underscored test name.
    cp -f "$outputFile" "$TMT_TEST_DATA"/"$fileprefix""_""$filename"
    # Set variable to data dir path.
    outputFile="$TMT_TEST_DATA"/"$fileprefix"_"$filename"
}

position=
check_opt_args () {
    local OPTIND
    while getopts s:o:p:t:port:message:outputfile:help-: OPT; do
	# support long options: https://stackoverflow.com/a/28466267/519360
        if [ "$OPT" = "-" ]; then   # long option: reformulate OPT and OPTARG
            OPT="${OPTARG%%=*}"       # extract long option name
        fi
        case "$OPT" in
            server )         needs_arg; eval "server=\"\$$OPTIND\"" ; OPTIND=$((OPTIND+1)) ;;
            s )              needs_arg; server=$OPTARG ;;
            outputfile )     needs_arg; eval "outputFile=\"\$$OPTIND\"" ; OPTIND=$((OPTIND+1)) ;;
            o )              needs_arg; outputFile="$OPTARG" ;;
            p )              needs_arg; disablePlugin="$OPTARG" ;;
            disable-plugin ) needs_arg; eval "disablePlugin=\"\$$OPTIND\"" ; OPTIND=$((OPTIND+1)) ;;
            t )              needs_arg; message="$OPTARG" ;;
            message )        needs_arg; eval "message=\"\$$OPTIND\"" ; OPTIND=$((OPTIND+1)) ;;
            port )           needs_arg; eval "port=\"\$$OPTIND\"" ; OPTIND=$((OPTIND+1)) ;;
            no-plugins )     disablePlugin="*" ;;
            help )           help=True ;;
            ??* )            die "Illegal option --$OPT" ;;  # bad long option
            ? )              exit 2 ;;  # bad short option (error reported via getopts)
        esac
    done
    shift $((OPTIND-1)) # remove parsed options and args from $@ list
    position=$((OPTIND-1))
}
# Options wrapped in quotes to ensure -t/--message argument is parsed as a string phrase
# rather than just the first string until a whitespace is encountered.
check_opt_args "$@"
shift $position # remove parsed options and args from $@ list
# Return help options when command issued with no options or arguments.
if [ $# -lt 2 ] || [ $help == True ]; then
    echo "Usage:"
    echo "  rstrnt-report-result [OPTION?] TASK_PATH RESULT [SCORE]"
    echo ""
    echo "Report results to lab controller. if you don't specify --port or"
    echo "the server url you must have RECIPE_URL and TASKID defined."
    echo "If HARNESS_PREFIX is defined then the value of that must be"
    echo "prefixed to RECIPE_URL and TASKID"
    echo ""
    echo "Help Options:"
    echo "  -h, --help                      Show help options"
    echo ""
    echo "Application Options:"
    echo "  --port=PORT                     restraintd port number (Service default: 8081)"
    echo "  -s, --server=URL                Server to connect to"
    echo "  -t, --message=TEXT              Short 100 characters or less message"
    echo "  -o, --outputfile=FILE           Log to upload with result, \$OUTPUTFILE is used by default"
    echo "  -p, --disable-plugin=PLUGIN     don't run plugin on server side"
    echo "  --no-plugins                    don't run any plugins on server side"
    echo ""
    exit 1
fi
TESTNAME=$1
TESTRESULT=$(echo "$2" | tr '[:upper:]' '[:lower:]')

if [[ "$0" == *"rhts-report-result"* ]]; then
    outputFile=$3
    copy_outputfile_to_data_dir
    METRIC=
    if [ $# -gt 3 ];then
        METRIC=$4
    fi
    write_report_file
    exit 0
fi

shift 2 #$((OPTIND-1)) # remove parsed options and args from $@ list
METRIC=
if [ $# -gt 0 ];then
    value1=$1
    firstChar=${value1:0:1}
    if [ "$firstChar" != '-' ]; then
        METRIC=$1
        shift 1
    fi
    check_opt_args "$@"
fi

if [ -n "$outputFile" ]; then
  copy_outputfile_to_data_dir
fi
write_report_file
